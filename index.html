<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音楽同期のライトシミュレーション</title>
    <style> 
        body { margin: 0; } 
        canvas { display: block; } 
    </style>
</head>
<body>
    <!-- Three.js ライブラリを読み込む -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // Three.jsの基本設定
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 照明をセットアップ
        var lights = [];
        for (var i = 0; i < 20; i++) {
            var light = new THREE.SpotLight(0xffffff, 1, 100, Math.PI / 6, 0.5);
            light.position.set(Math.random() * 20 - 10, 5, Math.random() * 10 - 5);
            light.target.position.set(0, 0, 0);
            scene.add(light.target);
            scene.add(light);
            lights.push(light);
        }

        // Web Audio APIを使って音楽をロード
        var audio = new Audio('audio/「スターゲイザー」（Live DVD & Blu-ray 『Du Gara Di Du』より） - YouTube.m4a');  // 音楽ファイルのパスを指定
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        var source = audioContext.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioContext.destination);

        var frequencyData = new Uint8Array(analyser.frequencyBinCount);

        // 音楽を再生
        audio.play();

        // アニメーションループ
        function animate() {
            requestAnimationFrame(animate);

            // 音楽の周波数データを取得
            analyser.getByteFrequencyData(frequencyData);

            // 照明の強度と色を音楽に合わせて変更
            lights.forEach(function(light, index) {
                var intensity = frequencyData[index % frequencyData.length] / 256;
                light.intensity = intensity * 2;
                light.color.setHSL(intensity, 1, 0.5);

                // ライトの位置も変更
                light.position.x = Math.sin(Date.now() * 0.001 + index) * 10;
                light.position.z = Math.cos(Date.now() * 0.001 + index) * 5;
            });

            renderer.render(scene, camera);
        }
        animate();

        // ブラウザの制限により、クリックで音楽再生を許可する
        document.addEventListener('click', function () {
            audioContext.resume();
        });
    </script>
</body>
</html>
